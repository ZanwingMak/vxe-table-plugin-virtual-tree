!function(e,t){if("function"==typeof define&&define.amd)define("vxe-table-plugin-virtual-tree",["exports","xe-utils"],t);else if("undefined"!=typeof exports)t(exports,require("xe-utils"));else{var n={exports:{}};t(n.exports,e.XEUtils),e.VXETablePluginVirtualTree=n.exports.default}}(this,function(e,d){"use strict";var t;function l(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function u(e){switch(e.vSize){case"mini":return 3;case"small":return 2;case"medium":return 1}return 0}function f(e,t,n){var r=n.index,i=n.items,a=1;return r&&(a=function e(t,n){var r=n[t.treeConfig.children],i=1;if(t.isTreeExpandByRow(n))for(var a=0;a<r.length;a++)i+=e(t,r[a]);return i}(t,i[r-1])),e.rowHeight*a-(r?1:12-u(t))}Object.defineProperty(e,"__esModule",{value:!0}),e.default=e.VXETablePluginVirtualTree=void 0,d=(t=d)&&t.__esModule?t:{default:t};var n={install:function(e){!function(e){var t=e.Vue,n=e.Table,r=e.Grid,i=e.setup,c=e.t,p=i(),a=Object.keys(n.props).filter(function(e){return-1===["data","treeConfig"].indexOf(e)}),s={name:"VxeVirtualTree",extends:r,data:function(){return{removeList:[]}},computed:{vSize:function(){return this.size||this.$parent.size||this.$parent.vSize},renderClass:function(){var e,t=this.tableProps,n=this.vSize,r=this.maximize,i=this.treeConfig;return["vxe-grid vxe-virtual-tree",(e={},l(e,"size--".concat(n),n),l(e,"t--animat",t.optimization.animat),l(e,"has--tree-line",i&&i.line),l(e,"is--maximize",r),e)]},tableExtendProps:function(){var t=this,n={};return a.forEach(function(e){n[e]=t[e]}),n}},watch:{columns:function(){this.loadColumn(this.handleColumns())},data:function(e){this.loadData(e)}},created:function(){var e=this.data;Object.assign(this,{fullTreeData:[],tableData:[],fullTreeRowMap:new Map}),this.handleColumns(),e&&this.reloadData(e)},methods:{renderTreeLine:function(e,t){var n=this.treeConfig,r=this.fullTreeRowMap,i=e.$table,a=e.row,s=e.column.treeNode;if(s&&n&&n.line){var l=a._X_LEVEL,o=r.get(a);return[s&&n&&n.line?t("div",{class:"vxe-tree--line-wrapper"},[t("div",{class:"vxe-tree--line",style:{height:"".concat(f(i,this,o),"px"),left:"".concat(l*(n.indent||20)+(l?2-u(this):0)+16,"px")}})]):null]}return[]},renderTreeIcon:function(e,t){var n=this,r=e.isHidden,i=e.row,a=this.treeConfig,s=a.children,l=a.indent,o=a.trigger,u=a.iconOpen,f=a.iconClose,h=i[s],c=!1,d={};return r||(c=i._X_EXPAND),o&&"default"!==o||(d.click=function(){return n.toggleTreeExpansion(i)}),[t("span",{class:"vxe-tree--indent",style:{width:"".concat(i._X_LEVEL*(l||20),"px")}}),t("span",{class:["vxe-tree-wrapper",{"is--active":c}],on:d},h&&h.length?[t("span",{class:"vxe-tree--btn-wrapper"},[t("i",{class:["vxe-tree--node-btn",c?u||p.icon.treeOpen:f||p.icon.treeClose]})])]:[])]},_loadTreeData:function(e){var t=this;return this.$nextTick().then(function(){return t.$refs.xTable.loadData(e)})},loadData:function(e){return this._loadTreeData(this.toVirtualTree(e))},reloadData:function(e){var t=this;return this.$nextTick().then(function(){return t.$refs.xTable.reloadData(t.toVirtualTree(e))}).then(function(){return t.handleDefaultTreeExpand()})},isTreeExpandByRow:function(e){return!!e._X_EXPAND},setTreeExpansion:function(e,t){var n=this;return e&&(d.default.isArray(e)||(e=[e]),e.forEach(function(e){return n.virtualExpand(e,!!t)})),this._loadTreeData(this.tableData)},setAllTreeExpansion:function(e){return this._loadTreeData(this.virtualAllExpand(e))},toggleTreeExpansion:function(e){return this._loadTreeData(this.virtualExpand(e,!e._X_EXPAND))},getTreeExpandRecords:function(){var t=this.hasChilds,n=[];return d.default.eachTree(this.fullTreeData,function(e){e._X_EXPAND&&t(e)&&n.push(e)},this.treeConfig),n},clearTreeExpand:function(){return this.setAllTreeExpansion(!1)},handleColumns:function(){var n=this;return this.columns.map(function(e){if(e.treeNode){var t=e.slots||{};t.icon=n.renderTreeIcon,t.line=n.renderTreeLine,e.slots=t}return e})},hasChilds:function(e){var t=e[this.treeConfig.children];return t&&t.length},getRecordset:function(){return{insertRecords:this.getInsertRecords(),removeRecords:this.getRemoveRecords(),updateRecords:this.getUpdateRecords()}},isInsertByRow:function(e){return!!e._X_INSERT},getInsertRecords:function(){var t=[];return d.default.eachTree(this.fullTreeData,function(e){e._X_INSERT&&t.push(e)},this.treeConfig),t},insert:function(e){return this.insertAt(e)},insertAt:function(e,t){var n=this,r=this.fullTreeData,i=this.tableData,a=this.treeConfig;d.default.isArray(e)||(e=[e]);var s=e.map(function(e){return n.defineField(Object.assign({_X_EXPAND:!1,_X_INSERT:!0,_X_LEVEL:0},e))});if(t)if(-1===t)r.push.apply(r,s),i.push.apply(i,s);else{var l=d.default.findTree(r,function(e){return e===t},a);if(!l||-1===l.index)throw new Error(c("vxe.error.unableInsert"));var o=l.items,u=l.index,f=l.nodes,h=i.indexOf(t);-1<h&&i.splice.apply(i,[h,0].concat(s)),o.splice.apply(o,[u,0].concat(s)),s.forEach(function(e){e._X_LEVEL=f.length-1})}else r.unshift.apply(r,s),i.unshift.apply(i,s);return this._loadTreeData(i).then(function(){return{row:s.length?s[s.length-1]:null,rows:s}})},getRemoveRecords:function(){return this.removeList},removeSelecteds:function(){var t=this;return this.remove(this.getSelectRecords()).then(function(e){return t.clearSelection(),e})},remove:function(e){var l=this,o=this.removeList,u=this.fullTreeData,f=this.treeConfig,h=[];return e?d.default.isArray(e)||(e=[e]):e=u,e.forEach(function(t){var e=d.default.findTree(u,function(e){return e===t},f);if(e){var n=e.item,r=e.items,i=e.index,a=e.parent;if(l.isInsertByRow(t)||o.push(t),a){var s=l.isTreeExpandByRow(a);s&&l.handleCollapsing(a),r.splice(i,1),s&&l.handleExpanding(a)}else l.handleCollapsing(n),r.splice(i,1),l.tableData.splice(l.tableData.indexOf(n),1);h.push(n)}}),this._loadTreeData(this.tableData).then(function(){return{row:h.length?h[h.length-1]:null,rows:h}})},handleDefaultTreeExpand:function(){var r=this,i=this.treeConfig,a=this.tableFullData;if(i){var e=i.expandAll,t=i.expandRowKeys,s=i.children;if(e)this.setAllTreeExpansion(!0);else if(t){var l=this.rowId;t.forEach(function(t){var e=d.default.findTree(a,function(e){return t===d.default.get(e,l)},i),n=e?e.item[s]:0;n&&n.length&&r.setTreeExpansion(e.item,!0)})}}},toVirtualTree:function(e){var s=this.fullTreeRowMap;return s.clear(),d.default.eachTree(e,function(e,t,n,r,i,a){e._X_EXPAND=!1,e._X_INSERT=!1,e._X_LEVEL=a.length-1,s.set(e,{item:e,index:t,items:n,paths:r,parent:i,nodes:a})}),this.fullTreeData=e.slice(0),this.tableData=e.slice(0),e},virtualExpand:function(e,t){return e._X_EXPAND!==t&&(e._X_EXPAND?this.handleCollapsing(e):this.handleExpanding(e)),this.tableData},handleExpanding:function(e){if(this.hasChilds(e)){var t=this.tableData,n=this.treeConfig,r=e[n.children],s=[],i=t.indexOf(e);if(-1===i)throw new Error("错误的操作！");d.default.eachTree(r,function(e,t,n,r,i,a){i&&!i._X_EXPAND||s.push(e)},n),e._X_EXPAND=!0,t.splice.apply(t,[i+1,0].concat(s))}return this.tableData},handleCollapsing:function(e){if(this.hasChilds(e)){var t=this.tableData,n=this.treeConfig,r=e[n.children],i=[];d.default.eachTree(r,function(e){i.push(e)},n),e._X_EXPAND=!1,this.tableData=t.filter(function(e){return-1===i.indexOf(e)})}return this.tableData},virtualAllExpand:function(t){var n=this;return d.default.eachTree(this.fullTreeData,function(e){n.virtualExpand(e,t)},this.treeConfig),this.tableData}}};t.component(s.name,s)}(e)}};e.VXETablePluginVirtualTree=n,"undefined"!=typeof window&&window.VXETable&&window.VXETable.use(n);var r=n;e.default=r});