!function(e,t){if("function"==typeof define&&define.amd)define("vxe-table-plugin-virtual-tree",["exports","xe-utils"],t);else if("undefined"!=typeof exports)t(exports,require("xe-utils"));else{var n={exports:{}};t(n.exports,e.XEUtils),e.VXETablePluginVirtualTree=n.exports.default}}("undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:this,function(e,f){"use strict";var t;function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function h(e){switch(e.vSize){case"mini":return 3;case"small":return 2;case"medium":return 1}return 0}function c(e,t,n){var r=n.index,i=n.items,a=1;return r&&(a=function e(t,n){var r=n[t.treeOpts.children],i=1;if(t.isTreeExpandByRow(n))for(var a=0;a<r.length;a++)i+=e(t,r[a]);return i}(t,i[r-1])),e.rowHeight*a-(r?1:12-h(t))}Object.defineProperty(e,"__esModule",{value:!0}),e.default=e.VXETablePluginVirtualTree=void 0,f=(t=f)&&t.__esModule?t:{default:t};var n={install:function(e){var t,n,r,i,a,d,v,s,l;n=(t=e).Vue,r=t.Table,i=t.Grid,a=t.setup,d=t.t,v=a(),s=Object.keys(r.props).filter(function(e){return-1===["data","treeConfig"].indexOf(e)}),l={name:"VxeVirtualTree",extends:i,data:function(){return{removeList:[]}},computed:{vSize:function(){return this.size||this.$parent.size||this.$parent.vSize},treeOpts:function(){return Object.assign({children:"children",hasChild:"hasChild",indent:20},v.treeConfig,this.treeConfig)},renderClass:function(){var e,t=this.tableProps,n=this.vSize,r=this.maximize,i=this.treeConfig,a=this.treeOpts;return["vxe-grid vxe-virtual-tree",(o(e={},"size--".concat(n),n),o(e,"t--animat",t.optimization.animat),o(e,"has--tree-line",i&&a.line),o(e,"is--maximize",r),e)]},tableExtendProps:function(){var t=this,n={};return s.forEach(function(e){n[e]=t[e]}),n}},watch:{columns:function(){this.loadColumn(this.handleColumns())},data:function(e){this.loadData(e)}},created:function(){var e=this.data;Object.assign(this,{fullTreeData:[],tableData:[],fullTreeRowMap:new Map}),this.handleColumns(),e&&this.reloadData(e)},methods:{renderTreeLine:function(e,t){var n=this.treeConfig,r=this.treeOpts,i=this.fullTreeRowMap,a=e.$table,s=e.row,l=e.column.treeNode;if(l&&n&&r.line){var o=s._X_LEVEL,u=i.get(s);return[l&&r.line?t("div",{class:"vxe-tree--line-wrapper"},[t("div",{class:"vxe-tree--line",style:{height:"".concat(c(a,this,u),"px"),left:"".concat(o*(r.indent||20)+(o?2-h(this):0)+16,"px")}})]):null]}return[]},renderTreeIcon:function(e,t,n){var r=this,i=e.isHidden,a=e.row,s=this.treeOpts,l=s.children,o=s.indent,u=s.trigger,h=s.iconOpen,c=s.iconClose,d=a[l],f=!1,p={};return i||(f=a._X_EXPAND),u&&"default"!==u||(p.click=function(){return r.toggleTreeExpansion(a)}),[t("div",{class:["vxe-cell--tree-node",{"is--active":f}],style:{paddingLeft:"".concat(a._X_LEVEL*o,"px")}},[d&&d.length?[t("div",{class:"vxe-tree--btn-wrapper",on:p},[t("i",{class:["vxe-tree--node-btn",f?h||v.icon.treeOpen:c||v.icon.treeClose]})])]:null,t("div",{class:"vxe-tree-cell"},n)])]},_loadTreeData:function(e){var t=this;return this.$nextTick().then(function(){return t.$refs.xTable.loadData(e)})},loadData:function(e){return this._loadTreeData(this.toVirtualTree(e))},reloadData:function(e){var t=this;return this.$nextTick().then(function(){return t.$refs.xTable.reloadData(t.toVirtualTree(e))}).then(function(){return t.handleDefaultTreeExpand()})},isTreeExpandByRow:function(e){return!!e._X_EXPAND},setTreeExpansion:function(e,t){var n=this;return e&&(f.default.isArray(e)||(e=[e]),e.forEach(function(e){return n.virtualExpand(e,!!t)})),this._loadTreeData(this.tableData)},setAllTreeExpansion:function(e){return this._loadTreeData(this.virtualAllExpand(e))},toggleTreeExpansion:function(e){return this._loadTreeData(this.virtualExpand(e,!e._X_EXPAND))},getTreeExpandRecords:function(){var t=this.hasChilds,n=[];return f.default.eachTree(this.fullTreeData,function(e){e._X_EXPAND&&t(e)&&n.push(e)},this.treeOpts),n},clearTreeExpand:function(){return this.setAllTreeExpansion(!1)},handleColumns:function(){var n=this;return this.columns.map(function(e){if(e.treeNode){var t=e.slots||{};t.icon=n.renderTreeIcon,t.line=n.renderTreeLine,e.slots=t}return e})},hasChilds:function(e){var t=e[this.treeOpts.children];return t&&t.length},getRecordset:function(){return{insertRecords:this.getInsertRecords(),removeRecords:this.getRemoveRecords(),updateRecords:this.getUpdateRecords()}},isInsertByRow:function(e){return!!e._X_INSERT},getInsertRecords:function(){var t=[];return f.default.eachTree(this.fullTreeData,function(e){e._X_INSERT&&t.push(e)},this.treeOpts),t},insert:function(e){return this.insertAt(e)},insertAt:function(e,t){var n=this,r=this.fullTreeData,i=this.tableData,a=this.treeOpts;f.default.isArray(e)||(e=[e]);var s=e.map(function(e){return n.defineField(Object.assign({_X_EXPAND:!1,_X_INSERT:!0,_X_LEVEL:0},e))});if(t)if(-1===t)r.push.apply(r,s),i.push.apply(i,s);else{var l=f.default.findTree(r,function(e){return e===t},a);if(!l||-1===l.index)throw new Error(d("vxe.error.unableInsert"));var o=l.items,u=l.index,h=l.nodes,c=i.indexOf(t);-1<c&&i.splice.apply(i,[c,0].concat(s)),o.splice.apply(o,[u,0].concat(s)),s.forEach(function(e){e._X_LEVEL=h.length-1})}else r.unshift.apply(r,s),i.unshift.apply(i,s);return this._loadTreeData(i).then(function(){return{row:s.length?s[s.length-1]:null,rows:s}})},getRemoveRecords:function(){return this.removeList},removeSelecteds:function(){return this.removeCheckboxRow()},removeCheckboxRow:function(){var t=this;return this.remove(this.getSelectRecords()).then(function(e){return t.clearSelection(),e})},remove:function(e){var l=this,o=this.removeList,u=this.fullTreeData,h=this.treeOpts,c=[];return e?f.default.isArray(e)||(e=[e]):e=u,e.forEach(function(t){var e=f.default.findTree(u,function(e){return e===t},h);if(e){var n=e.item,r=e.items,i=e.index,a=e.parent;if(l.isInsertByRow(t)||o.push(t),a){var s=l.isTreeExpandByRow(a);s&&l.handleCollapsing(a),r.splice(i,1),s&&l.handleExpanding(a)}else l.handleCollapsing(n),r.splice(i,1),l.tableData.splice(l.tableData.indexOf(n),1);c.push(n)}}),this._loadTreeData(this.tableData).then(function(){return{row:c.length?c[c.length-1]:null,rows:c}})},handleDefaultTreeExpand:function(){var r=this,e=this.treeConfig,i=this.treeOpts,a=this.tableFullData;if(e){var s=i.children,t=i.expandAll,n=i.expandRowKeys;if(t)this.setAllTreeExpansion(!0);else if(n){var l=this.rowId;n.forEach(function(t){var e=f.default.findTree(a,function(e){return t===f.default.get(e,l)},i),n=e?e.item[s]:0;n&&n.length&&r.setTreeExpansion(e.item,!0)})}}},toVirtualTree:function(e){var s=this.fullTreeRowMap;return s.clear(),f.default.eachTree(e,function(e,t,n,r,i,a){e._X_EXPAND=!1,e._X_INSERT=!1,e._X_LEVEL=a.length-1,s.set(e,{item:e,index:t,items:n,paths:r,parent:i,nodes:a})}),this.fullTreeData=e.slice(0),this.tableData=e.slice(0),e},virtualExpand:function(e,t){return e._X_EXPAND!==t&&(e._X_EXPAND?this.handleCollapsing(e):this.handleExpanding(e)),this.tableData},handleExpanding:function(e){if(this.hasChilds(e)){var t=this.tableData,n=this.treeOpts,r=e[n.children],s=[],i=t.indexOf(e);if(-1===i)throw new Error("错误的操作！");f.default.eachTree(r,function(e,t,n,r,i,a){i&&!i._X_EXPAND||s.push(e)},n),e._X_EXPAND=!0,t.splice.apply(t,[i+1,0].concat(s))}return this.tableData},handleCollapsing:function(e){if(this.hasChilds(e)){var t=this.tableData,n=this.treeOpts,r=e[n.children],i=[];f.default.eachTree(r,function(e){i.push(e)},n),e._X_EXPAND=!1,this.tableData=t.filter(function(e){return-1===i.indexOf(e)})}return this.tableData},virtualAllExpand:function(t){var n=this;return f.default.eachTree(this.fullTreeData,function(e){n.virtualExpand(e,t)},this.treeOpts),this.tableData}}},n.component(l.name,l)}};e.VXETablePluginVirtualTree=n,"undefined"!=typeof window&&window.VXETable&&window.VXETable.use(n);var r=n;e.default=r});